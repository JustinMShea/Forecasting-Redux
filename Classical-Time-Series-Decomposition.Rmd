---
title: "Classical Time Series Decomposition Handout"
subtitle: "Introduction to Time Series"
date: "Compiled and edited by Justin M. Shea"
output:
  tufte::tufte_handout:  
    citation_package: natbib
    latex_engine: xelatex 
link-citations: yes
---

#The Underlying Structure of Time Series Data

##Classical Time Series Decomposition
Given an economic time series as shown in Figure 1, one of the most common approaches to understanding such data is through _classical time series decomposition_. The composition of the time series is decomposed into four components: trend, cyclical, seasonal, and irregular components. 

\medskip

Considering the four components collectively is the method of the _classical time series decomposition_. The components can be either added together, or multiplied by each other, to define a time series. If a time series decomposition is additive, all components are expressed in the physical units of $Y_t$ and simply added together. If a times series decomposition is expressed in multiplicative form, component values are expressed in a combination of physical units and percentage of trend $T_t$, and multiplied together. The actual value $Y_t$ is the _product_ of the trend component $T_t$ expressed in physical units, the cyclical component $C_t$ expressed as a percentage of $T_t$, the seasonal component $S_t$ as a percentage of $T_t \times C_t$ , and the irregular component expressed as a percentage of $T_t \times C_t \times S_t$.

\bigskip   

**Additive Time Series Decomposition**
$$Y_t = T_t + C_t + S_t + I_t$$.  

**Multiplicative Time Series Decomposition**
$$Y_t = T_t \times C_t \times S_t \times I_t$$.    

Trend, seasonal fluctuations, and irregular variations are usually easily identifiable
components of a time series. Calculations of trend and seasonality are quite straightforward,
and adjustments for irregular variations can be simply handled. Determining the long term
cyclical component of a time series is not so direct, and is a known limitation of this method. Long term business cycles are beyond the scope of this topic, and will be discussed in other chapters.

\newpage

##The Trend Component

The trend component of a time series at time $t$, denoted $T_t$, is the upward or downward progression of the data over time. Figure 11 below has a trend line superimposed over the actual data, indicating a upward trend. The OLS regression line of $T_t$ is defined in the margin^[$$T_t = \beta_{0} + \beta_{1}TIME_t$$]. For our example, the trend of the Sales Volume series is calculated by regressing Sales Volume against time period.

$$Sales_t = \beta_{0} + \beta_{1}Period_t$$


```{r, fig.width = 10, fig.height = 6, fig.fullwidth = TRUE, fig.cap = "Sales Volume Data with Plotted OLS Trend line.", message=FALSE, error=FALSE, comment=FALSE, warning=FALSE, echo=FALSE}
trend <- lm(Sales ~ Period, table_61_series)
table_610 <- data.frame(table_61_series, Trend = trend$fitted.values)
table_610_series <- gather(table_610, Period)
colnames(table_610_series) <- c("Period", "Series", "Value")

figure_610 <- ggplot(data = table_610_series, aes(y = Value, x = Period, col = Series)) +
  geom_line() + 
 scale_y_continuous(breaks=seq(0,800,100), limits = c(0,800), sec.axis = dup_axis()) +
  scale_x_continuous(breaks=seq(0,54,6), limits = c(0,54))

ggdraw( figure_610 + theme_tufte() )
```


\newpage
##The Cyclical Fluctuations Component

The cyclical component of a time series at each time step $t$, denoted $C_t$, and illustrated below in Figure 12 and 13, are the broad up-and-down swings of the series around it's trend line. These cycles of high and low can last more than a year, having different lengths and amplitudes. The cyclical component of a time series is usually attributable to some larger
aspect of the economy or business cycle by which this particular data have been affected.

```{r, fig.width = 10, fig.height = 4, fig.fullwidth = TRUE, fig.cap = "Sales Volume Data with Trend line and Cycle.", message=FALSE, error=FALSE, comment=FALSE, warning=FALSE, echo=FALSE}
table_611 <- data.frame(table_61_series, Trend = trend$fitted.values, t.Cycle = trend$residuals)
table_611_series <- gather(table_611, Period)
colnames(table_611_series) <- c("Period", "Series", "Value")

figure_611 <- ggplot(data = table_611_series, aes(y = Value, x = Period, col = Series)) +
  geom_line() + 
   geom_hline(yintercept = 1, linetype="dashed", alpha = 1/2) +
  scale_y_continuous(breaks=seq(-200,800,200), limits = c(-200,800), sec.axis = dup_axis()) + 
  scale_x_continuous(breaks=seq(0,54,6), limits = c(0,54))

ggdraw( figure_611 + theme_tufte() )
```



```{r, fig.width = 10, fig.height = 4, fig.fullwidth = TRUE, fig.cap = "Sales Volume Data, Cycle component.", message=FALSE, error=FALSE, comment=FALSE, warning=FALSE, echo=FALSE}
figure_612 <- ggplot(data = table_611, aes(y = t.Cycle, x = Period, col = t.Cycle)) +
  geom_line() + 
  geom_hline(yintercept = 0, linetype="dashed", alpha = 1/2) +
  ylim(-175,125) + 
  scale_x_continuous(breaks=seq(0,54,6), limits = c(0,54))

ggdraw( figure_612 + theme_tufte() )
```

\newpage

```{r, message=FALSE, error=FALSE, comment=FALSE, warning=FALSE, echo=FALSE}
trend_smooth <- ma(table_61_series[,2], order = 12, centre = TRUE)
table_smooth <- data.frame(table_61_series, Trend = trend_smooth)
table_smooth_series <- gather(table_smooth, Period)
colnames(table_smooth_series) <- c("Period", "Series", "Value")

figure_smooth <- ggplot(data = table_smooth_series, aes(y = Value, x = Period, col = Series)) +
  geom_line() + 
  ylim(0,800) + 
  scale_x_continuous(breaks=seq(0,54,6), limits = c(0,54))

#ggdraw(switch_axis_position(figure_smooth + theme_tufte(), axis = 'y'))
```

```{r, message=FALSE, error=FALSE, comment=FALSE, warning=FALSE, echo=FALSE}
table_smooth_c <- data.frame(table_61_series, Trend = trend_smooth, t.Cycle = table_61_series[,2]-trend_smooth)
table_smooth_c_series <- gather(table_smooth_c, Period)
colnames(table_smooth_c_series) <- c("Period", "Series", "Value")
```

##The Seasonal Fluctuations Component

The seasonal component of a time series at time $t$, denoted $S_t$, illustrated in the following example, are the reoccurring fluctuations within a year around the trend/cyclical components. Most business data reveal seasonal fluctuations, or _seasonality_, so it is important for businesses to know and plan for changes in sales or economic activity that will be more or less normal due to the seasonal nature of their product. For example, if sales are low or high due to seasonality, as oppose to trend, business may better adjust their expectations accordingly.


##Seasonal Indices: The Ratio-to-Moving-Average Method

There are many occasions in the analysis of time series when we wish to isolate the seasonality in the data. This is known as determining the _seasonal indices_ and then _deseasonalizing the data_. One method is the __*Ratio-to-Moving-Average*__ method.

This was first developed in 1922 by Frederick Macaulay at the National Bureau of Economic Research and then adopted and promoted by Julius Shiskin of the U.S. Bureau of the Census. Often referred to as the Census II decomposition, this method has evolved and now in its most recent version, it is the Census **[\textcolor{blue}{X-13 ARIMA-SEATS decomposition}](http://www.census.gov/srd/www/x13as/)**. As the name suggests, the topic has become considerably more computationally sophisticated. The following basic example using the ratio-to-moving-average method offers a solution, and it is the initial step for some of the more advanced methods in use today.

##Seasonal Index, Basic Example

We shall use the Sales Volume time series from Table 2 and Figure 1 for this example. Because they are monthly data and there are 12 months in a year, we first determine the 12-period Centered Moving Average Smoothing of the data. As there are 48 observations, or 4 years of data, we start with period 7 and end at period 42. Although the Centered Moving Average method does not allow one to calculate the cyclical component at the beginning and end of a time series, this is not an issue when creating Seasonal indices provided at least 2 years of data exist.


**Step 1:** Determine the 12-period Center Moving Average Smoothing of the Data. We use the formula on page 12.


**Step 2:** Calculate the Ratio of the Actual to the Moving Average (hence, the name of the method).


$$Ratio_t = \frac{Sales_t}{CMA_t(12)}$$

\newpage
```{r, fig.cap = "Ratio to Moving Average Method", message=FALSE, error=FALSE, comment=FALSE, warning=FALSE, echo=FALSE}
# Seasonal Component

library(forecast)
# Create centered 12 period Moving Average
smooth_12_2 <- ma(table_61_series[,2], order = 12, centre = TRUE)
# Create new data frame with CMA(12) and monthly number
table_68_series <- data.frame("Period"=table_61_series[,1], "Month"=rep(month.abb), "Sales"=table_61_series[,2], "CMA12"=round(smooth_12_2, digits=2))
table_68_series <- data.frame(table_68_series, "Ratio" = round(table_68_series$Sales/smooth_12_2, digits = 2))

table_68_wide <- data.frame(table_68_series[1:24,],table_68_series[25:48,])
names_68 <- colnames(table_68_series)
colnames(table_68_wide) <- c(names_68, names_68)

kable(table_68_wide,  caption = "Ratio to Moving Average Method")
```

**Step 3:** We collect the Ratios in a table by Month and determine the Median value of the ratios. These Median values are often termed the _Unadjusted Seasonal Indices_.

```{r, fig.cap = "Ratios of Actual Sales to CWMA(12) Smothing",  message=FALSE, error=FALSE, comment=FALSE, warning=FALSE, echo=FALSE}
# Create wide table, columns by month
table_69 <- matrix(table_68_series$Ratio, ncol=12, byrow=TRUE)
colnames(table_69) <- rep(month.abb)
table_69_ratio <- data.frame(table_69)

table_69_med <- matrix(table_68_series$Sales/smooth_12_2 , ncol=12, byrow=TRUE)
colnames(table_69_med) <- rep(month.abb)
table_69_med <- data.frame(table_69_med)

###
table_69_median <- apply(table_69_med, MARGIN = 2, FUN = median, na.rm=TRUE)
###

table_69_median_tbl <- round(matrix(table_69_median, ncol=12, byrow=TRUE), digits = 2)
colnames(table_69_median_tbl) <- rep(month.abb)
table_69_median_tbl <- data.frame(table_69_median_tbl)

display_table_69 <- round(rbind(table_69_med, table_69_median), digits = 2)
row.names(display_table_69) <- c("Year 1", "Year 2", "Year 3", "Year 4", "Median")

kable(display_table_69, caption = "Ratios of Actual Sales to CWMA(12) Smoothing, with Median Monthly values (Unadjusted Seasonal Index)", row.names = TRUE)

# Create Adjusted Seasonal Index
table_69_adjusted <- (12/sum(table_69_median))*table_69_median

table_69_adjusted_tbl <- round(matrix(table_69_adjusted, ncol=12, byrow=TRUE), digits = 2)
colnames(table_69_adjusted_tbl) <- rep(month.abb)
table_69_adjusted_tbl <- data.frame(table_69_adjusted_tbl)

```

\newpage

**Step 4:** We expect the average of the seasonal indices to be 1, so with 12 periods in the season, the sum of the seasonal indices must equal 12. Because their sum is `r round(sum(table_69_median), digits = 2)`, we multiply each Unadjusted Seasonal Index by $\frac{12}{`r round(sum(table_69_median), digits = 2)`}$. 
For example, for Month 1 (January): 
$$\frac{12}{`r round(sum(table_69_median), digits = 2)`} \times `r round(table_69_median[[1]], digits = 2)` = `r round(table_69_adjusted[[1]], digits =2)`$$ 

The sum of the Adjusted Seasonal Indices equals 12, so their average equals 1. As one might have expected, Sales are seasonally strongest in December, the 12th month, and weakest in July, the 7th month. The Adjusted Seasonal index values reflect this.



```{r, fig.cap = "Adjusted Seasonal Index", message=FALSE, error=FALSE, comment=FALSE, warning=FALSE, echo=FALSE}
# Create Adjusted Seasonal Index
kable(table_69_adjusted_tbl, caption = "Adjusted Seasonal Index" )
```

```{r, fig.cap = "Sales Volum Data, Seasonal Index.",fig.width = 10, fig.height = 5, fig.fullwidth = TRUE,  message=FALSE, error=FALSE, comment=FALSE, warning=FALSE, echo=FALSE}
#Chart seasonal index 
# dataframe for chart

table_69_series <- data.frame("Period"=seq(1,12,1), "Unadjusted Index" =   table_69_median[1:12],"Adjusted Index"=table_69_adjusted[1:12])

table_69_series <- gather(table_69_series, Period)
colnames(table_69_series) <- c("Period", "Series", "Value")

# chart object
figure_69 <- ggplot(data = table_69_series, aes(y = Value, x = Period, col = Series)) +
  geom_line() + 
  geom_hline(yintercept = 1, linetype="dashed", alpha = 1/2) +
  scale_y_continuous(breaks=seq(.9,1.3,.05), limit = c(.9,1.3), sec.axis = dup_axis()) +
  scale_x_continuous(breaks=seq(1,12,1), limits = c(0,12), labels = rep(month.abb))
# draw
ggdraw( figure_69 + theme_tufte() )
```


\newpage

**Step 5:** The original, Actual, values are divided by the Seasonal Indices, creating a De-Seasonalized Series.
$$DeSeasonalized_t = \frac{Sales_t}{Seasonal Index_t}$$
Notice in the Figure below that the periods of (11,12), (23,24), (35,36), and (47,48) are reoccurring local peaks in Sales Volume. This is the seasonality of Sales.


```{r, fig.width = 10, fig.height = 5, fig.fullwidth = TRUE, fig.cap = "Sales Volume with DeSeasonalized Data.", message=FALSE, error=FALSE, comment=FALSE, warning=FALSE, echo=FALSE}
# Add to table_68 series and calculate seasonally adjusted values
table_614_seasonal <- data.frame(table_68_series, "Seasonal" = table_69_adjusted, "DeSeasonalized"= table_68_series$Sales/table_69_adjusted)
colnames(table_614_seasonal) <- c(colnames(table_68_series), "Seasonal", "DeSeasonalized")


# Create Series for chart
table_614_series <- data.frame(table_614_seasonal)

table_614_series2 <- gather(table_614_series[,c(1,3,7)], Period)
colnames(table_614_series2) <- c("Period", "Series", "Value")

# Create chart object
figure_614 <- ggplot(data = table_614_series2, aes(y = Value, x = Period, col = Series)) +
  geom_line() + 
  geom_vline(xintercept = c(11.5,23.5,35.5,47.5), alpha = 1/3, linetype="dashed") +
  scale_y_continuous(breaks=seq(0,800,200), limits = c(0,800), sec.axis = dup_axis()) + 
  scale_x_continuous(breaks=seq(0,54,6), limits = c(0,54))

# Call graphics Device to illustrate chart
ggdraw( figure_614 + theme_tufte())
```


```{r, fig.cap = "Adjusted Seasonal Index", message=FALSE, error=FALSE, comment=FALSE, warning=FALSE, echo=FALSE}
kable(table_614_seasonal, digits = 2, caption = "Actual Sales, CWMA(12) Smoothing, Ratio, Seasonal Index, and DeSeasonaled Sales" )
```


\newpage

##The Irregular Variations Component

The irregular component of a time series at time $t$, denoted $I_t$, is illustrated in Figure
16 below. They are the random, unexpected deviations from the trend/cyclical/seasonal components.
Irregular changes or “shocks" to a time series are considered nonrecurring chance events. They can be the result of unusually good (The movie E.T. and Reese's Pieces Candy) or unusually bad (Tylenol poisoning) publicity about a product.

In Figure 16 below, an irregular variation of the Sales Volume series occurs around period 30 as Sales drop abruptly and then returns to the usual upward trend.

$$Irregular_t = \frac{Sales_t}{Trend_t \times SeasonalIndex_t}$$


```{r, fig.width = 10, fig.height = 5, fig.fullwidth = TRUE, fig.cap = "Sales Volume with DeSeasonalized Data.", message=FALSE, error=FALSE, comment=FALSE, warning=FALSE, echo=FALSE}
# Irregular values
#Add to table_614_series series and calculate irregular values.
table_615_Irregular <- data.frame(table_614_seasonal, "Irregular" = table_614_seasonal$Sales/(table_614_seasonal$CMA12*table_614_seasonal$Seasonal))


# Create chart object
figure_Irregular_series <- ggplot(data = table_615_Irregular, 
                                  aes(y = Irregular, x = Period, col = Irregular)) +
  geom_line() + 
  geom_hline(yintercept = 1, linetype="dashed", alpha = 1/2) +
  scale_x_continuous(breaks=seq(0,54,6), limits = c(0,54))

# Call graphics Device to illustrate chart
ggdraw(figure_Irregular_series + theme_tufte())
```

\newpage

## Closing remarks
The astute reader may have noticed that we used the 12-Period Centered Moving Average to assist in calculating the seasonal component, not the OLS linear trend used in our initial example. The 12-Period Centered Moving Average discussed on pg. 12 offers a more dynamic fit for measuring the monthly Sales trend than the rigid OLS line. This is a topic we will cover in future chapters. For now, the reader is left to consider the benefits of using a smoothing function to measure the trend of a time series. 


```{r, fig.width = 10, fig.height = 5, fig.fullwidth = TRUE, fig.cap = "Sales Data with CWMA(12) Trend and Cycle.", message=FALSE, error=FALSE, comment=FALSE, warning=FALSE, echo=FALSE}

figure_smooth_c <- ggplot(data = table_smooth_c_series, aes(y = Value, x = Period, col = Series)) +
  geom_line() + 
   geom_hline(yintercept = 1, linetype="dashed", alpha = 1/2) +
  scale_y_continuous(breaks=seq(-200,800,200), limits = c(-200,800), sec.axis = dup_axis()) + 
  scale_x_continuous(breaks=seq(0,54,6), limits = c(0,54))

ggdraw( figure_smooth_c + theme_tufte() )
```
```{r, fig.width = 10, fig.height = 3, fig.fullwidth = TRUE, fig.cap = "Sales Data, CWMA(12) Cycle component.", message=FALSE, error=FALSE, comment=FALSE, warning=FALSE, echo=FALSE}
figure_smooth_c2 <- ggplot(data = table_smooth_c, aes(y = t.Cycle, x = Period, col = t.Cycle)) +
  geom_line() + 
  geom_hline(yintercept = 0, linetype="dashed", alpha = 1/2) +
  scale_y_continuous(breaks=seq(-175,125,50), limits = c(-175,125), sec.axis = dup_axis()) +
  scale_x_continuous(breaks=seq(0,54,6), limits = c(0,54))

ggdraw(figure_smooth_c2 + theme_tufte())
```
